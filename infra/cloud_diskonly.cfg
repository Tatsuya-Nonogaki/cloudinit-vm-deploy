# Disk-only cloud-init configuration
# Purpose: Minimal, safe cloud.cfg to be installed on a clone prior to
#          running the disk-only reapply flow (Phase‑2 DiskOnly + Phase‑3).
# Guiding principles:
#  - Avoid any user/SSH/hosts/network mutation.
#  - Disable SSH host key regeneration.
#  - Keep only the modules needed to read the seed and perform partition/filesystem/swap work.
#  - Modules are set to once-per-instance so a fresh instance-id will cause them to run.
#
# IMPORTANT:
#  - Backup the existing /etc/cloud/cloud* ; init-vm-cloudinit-diskonly.sh will do it for you.
#  - Do NOT include network/user/write_files changes in the seed (user-data) used for disk-only.
#  - Test on a non-production VM first.

users: []
disable_root: false

# Keep the usual mount defaults (unchanged)
mount_default_fields: [~, ~, 'auto', 'defaults,nofail,x-systemd.after=cloud-init-network.service,_netdev', '0', '2']

# Prevent cloud-init from removing/regenerating SSH host keys in disk-only flow
ssh_deletekeys: false
ssh_genkeytypes: []

# These settings goes to /etc/cloud/cloud.cfg.d/99-override.cfg instead.
# preserve_hostname: true
# manage_etc_hosts: false

# Minimal init-stage modules sufficient for reading the seed and performing disk ops.
# Note: keep seed_random/bootcmd so cloud-init can read the seed datasource correctly.
cloud_init_modules:
  - [seed_random, once-per-instance]
  - [bootcmd, once-per-instance]
  - [growpart, once-per-instance]
  - [resizefs, once-per-instance]
  - [disk_setup, once-per-instance]
  - [mounts, once-per-instance]
  - [ca_certs, once-per-instance]

# Allow runcmd so the seed's runcmd block can perform the resize/swap script.
cloud_config_modules:
  - [runcmd, once-per-instance]

# Minimal final modules: avoid package updates and other heavy actions.
cloud_final_modules:
  - [write_files_deferred, once-per-instance]
  - [final_message, once-per-instance]

system_info:
  distro: rhel
  network:
    renderers: ['sysconfig', 'eni', 'netplan', 'network-manager', 'networkd']
  paths:
    cloud_dir: /var/lib/cloud/
    templates_dir: /etc/cloud/templates/
  ssh_svcname: sshd
